<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/assets/css/markdown.css">
    <link rel="stylesheet" href="/assets/css/github-markdown-light.css">
</head>

<body>
    <article class="markdown-body">
<h1 id="pipeline-%E7%BC%96%E5%86%99" tabindex="-1">Pipeline 编写</h1>
<h2 id="%E7%BC%96%E5%86%99%E8%A7%84%E8%8C%83" tabindex="-1">编写规范</h2>
<h3 id="%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83" tabindex="-1">命名规范</h3>
<p>为保证资源的美观一致，请尽量遵循以下现有规则。</p>
<h4 id="%E8%B5%84%E6%BA%90%E5%91%BD%E5%90%8D" tabindex="-1">资源命名</h4>
<ul>
<li>对于图片等文件，采用大驼峰命名法，所有单词的首字母都大写。</li>
<li>对于 <code>pipeline</code> 文件夹下的 json 文件名，一般采用蛇形命名法，单词之间用下划线分隔，所有字母小写，<br>
特别地，专有名词的活动采取大驼峰命名法，一般在 <code>activity</code> 文件夹内。</li>
<li>对于 <code>image</code> 下文件夹，每个文件夹对应一个 <code>pipeline</code> 文件夹下的 json 文件，文件夹名采用大驼峰命名法，<br>
特别地，<code>activity</code> 内 json 文件对应的 <code>image</code> 放到 <code>Combat/Activity</code> 处。</li>
</ul>
<h4 id="node-%E5%91%BD%E5%90%8D" tabindex="-1">Node 命名</h4>
<p>node 的定义为符合任务流水线（Pipeline）协议的一个完整的 <code>JsonObject</code>，大多数采用大驼峰命名法，特别地，部分情况下用 <code>_</code> 连接前、后缀。</p>
<p>前缀一般为 <code>Sub</code> 或 当前活动缩写（如 <code>SOD</code> 黄昏的音序、<code>EITM</code> 山麓的回音）等。（其他情况建议不要前缀）</p>
<p>后缀一般为 <code>数字</code> 或 <code>状态</code> 等，表示该 node 的具体阶段或状态。（建议新写的 node 不加后缀）</p>
<h3 id="node-%E7%BC%96%E5%86%99" tabindex="-1">Node 编写</h3>
<p>具体内容参见<a href="https://github.com/MaaXYZ/MaaFramework/blob/main/docs/zh_cn/3.1-%E4%BB%BB%E5%8A%A1%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%8D%8F%E8%AE%AE.html" target="_top" rel="noopener noreferrer">Pipeline 协议详细说明</a></p>
<div class="markdown-alert markdown-alert-note"><p class="markdown-alert-title"><svg class="octicon octicon-info mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p><p></p>
<ul>
<li><code>next</code> 放置当前 node 的出口 node，<code>interrupt</code> 放置当前 node 的中断 node。</li>
<li>多将具有 Flag 性质的 node 设为出口 node，作为当前 node 完成的标志。</li>
<li>降低 node 之间的耦合。<br>
如 <code>BackButton</code> 一般不设置 <code>next</code>，而是作为一个“异常处理”放入 <code>interrupt</code>，以便保证任务流程的清晰，并方便 interrupt node 被其它任务复用。</li>
<li>部分情况下，可将 node 加入自身 <code>next</code> 。（存在动作未被游戏正确接受/尚未在游戏内生效的情况）</li>
<li>在涉及切换页面的 node 中加入 <code>post_wait_freezes</code> ，并使用 <code>object</code> 作为值，设置合适的 <code>time</code> 和 <code>target</code>。</li>
<li>涉及滑动的操作时，在后面加个点击操作，以便确保画面稳定。</li>
</ul>
</div>
<div class="markdown-alert markdown-alert-warning"><p class="markdown-alert-title"><svg class="octicon octicon-alert mr-2" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p><p></p>
<ul>
<li>慎用 <code>inverse</code> 字段，这可能会导致任务的不可预测。<br>
如必须使用，请保证其有带 <code>post_wait_freezes</code> 的前置 node，以保证匹配该 node 时处于预期状态。</li>
<li>慎用“无条件匹配” node。<br>
node 的 <code>recognition</code> 字段默认为 <code>DirectHit</code>。 <code>recognition</code> 字段为 <code>DirectHit</code> 的 node 即为“无条件匹配” node。<br>
使用“无条件匹配” node，可能导致任务运行到非预期状态时，程序未能正常报错，而是循环匹配该 node，造成任务卡死。<br>
如非必要，请选择其它实现逻辑完成任务。</li>
</ul>
</div>
<h4 id="node-%E8%BF%9E%E6%8E%A5" tabindex="-1">Node 连接</h4>
<p>Node 间主要通过 <code>next</code> 或 <code>interrupt</code> 字段连接。</p>
<p><code>next</code>完成 node 间的串联，<code>interrupt</code>实现执行以当前 interrupt node为 entry 的新任务链，并在该任务链完成后返回当前 node。</p>
<p>简单表示如下：</p>
<pre><code class="language-mermaid">graph LR
    A(Task Entry&lt;br&gt;Node A) --&gt; |next| B(Node B)
    A --&gt; |interrupt| C(Node C)
    C --&gt; |return| A
</code></pre>
<p>将 interrupt node 变复杂点：</p>
<pre><code class="language-mermaid">graph LR
    A(Task Entry&lt;br&gt;Node A) --&gt; |next| B(Node B)
    A --&gt; |interrupt| C(Node C)
    C --&gt; |next| D(Node D)
    C --&gt; |interrupt| E(Node E)
    D --&gt; |return| A
    E --&gt; |return| C
</code></pre>
<p>为保证任务链有一个较好的结构，请按以下原则进行 node 连接：</p>
<ol>
<li>标志完成阶段性任务的 node 应放在 <code>next</code> 中。</li>
<li>为达到匹配 <code>next</code> 中 node 而处理其他状况的 node 应放在 <code>interrupt</code> 中。</li>
</ol>
<p>如 活动刷取任务、位于活动主界面、进入活动主界面 三者关系如下：</p>
<pre><code class="language-mermaid">graph LR
   A(活动刷取任务) --&gt; |next| B(位于活动主界面)
   A --&gt; |interrupt| C(进入活动主界面)
   C --&gt; |return| A
</code></pre>
<p>这里“进入活动主界面”就不会放在 <code>next</code> ，而是放入 <code>interrupt</code> 。</p>
<h4 id="next-%26-interrupt-node-%E6%8E%92%E5%BA%8F" tabindex="-1">Next &amp; Interrupt Node 排序</h4>
<p>总体上，<code>interrupt</code> 第一个 node 比 <code>next</code> 最后一个 node 低一优先级。</p>
<p>在 <code>next</code> 或 <code>interrupt</code> 内部，统一先按照优先级由高到低顺序排列，不能出现优先级倒挂的情况。举例：</p>
<pre><code class="language-plaintext">现有判断一个小弹窗的 node B，和判断跳出弹窗前界面的 node A。
如果弹窗出现时依旧能匹配到A，则B的优先级应该高于A，否则会出现无法处理B而卡死于A的情况。
</code></pre>
<p>同一优先级内的 node，可按照匹配频率由高到低顺序排列，以便提高 node 命中率，降低资源消耗。</p>
<h4 id="%E6%B3%A8%E9%87%8A%E8%A7%84%E8%8C%83" tabindex="-1">注释规范</h4>
<p><code>pipeline.json</code> 文件中，注释共两种属性字段：</p>
<ol>
<li><code>.*_doc$|^doc$</code>： 以 _doc 结尾的字符串或者正好是 doc 的字符串。</li>
<li><code>.*_code$|^code$</code>：以 _code 结尾的字符串或者正好是 code 的字符串。</li>
</ol>
<p>前者为对当前 node（或某字段）的说明，后者为对必填字段的占位。举例：</p>
<pre><code class="language-json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">&quot;EnterTheActivityMain&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">&quot;doc&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;进入当期活动主界面&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;template_code&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;在interface.json中修改template&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;recognition&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;TemplateMatch&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;roi&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-number">885</span><span class="hljs-punctuation">,</span>
            <span class="hljs-number">123</span><span class="hljs-punctuation">,</span>
            <span class="hljs-number">340</span><span class="hljs-punctuation">,</span>
            <span class="hljs-number">183</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;action&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Click&quot;</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">&quot;post_wait_freezes&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">&quot;time&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">500</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">&quot;target&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
                <span class="hljs-number">0</span><span class="hljs-punctuation">,</span>
                <span class="hljs-number">179</span><span class="hljs-punctuation">,</span>
                <span class="hljs-number">190</span><span class="hljs-punctuation">,</span>
                <span class="hljs-number">541</span>
            <span class="hljs-punctuation">]</span>
        <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>doc</code> 为当前 node 说明。</p>
<p><code>template_code</code> 为必填字段占位，
原因是 <code>recognition</code> 为 <code>TemplateMatch</code> 时， “template” 字段必填，但我们想在 <code>interface.json</code> 中修改，而不是该 json 文件中。故用 <code>template_code</code> 占位。</p>

    </article>
</body>

</html>